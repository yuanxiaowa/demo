<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>括号匹配检验</title>
</head>

<body>
  <section id="section1">
    <fieldset>
      <legend>括号匹配检验</legend>
      <input type="text" id="txt">
      <button id="btn">校验</button>
      <div id="tip"></div>
    </fieldset>
  </section>
  <section id="section2">
    <fieldset>
      <legend>行编辑程序</legend>
      <div>#去除前一个字符, @去除到行首字符</div>
      <input type="text" id="txt2">
      <button id="btn2">添加</button>
      <div id="tip2"></div>
    </fieldset>
  </section>
  <section id="section3">
    <fieldset>
      <legend>十进制转八进制</legend>
      <input type="text" id="txt3">
      <button id="btn3">转换</button>
      <div id="tip3"></div>
    </fieldset>
  </section>
  <section id="section4">
    <fieldset>
      <legend>表达式求值</legend>
      <input type="text" id="txt4">
      <button id="btn4">求值</button>
      <div id="tip4"></div>
    </fieldset>
  </section>
  <script src="//cdn.bootcss.com/jquery/2.1.4/jquery.js"></script>
  <script>
  var $txt = $('#txt');
  var $tip = $('#tip');
  $('#btn').click(function() {
    if (isMatchBrackets($txt.val())) {
      $tip.text('合法');
    } else {
      $tip.text('不合法');
    }
  });

  var $txt2 = $('#txt2');
  var $tip2 = $('#tip2');
  $('#btn2').click(function() {
    var val = $txt2.val();
    $tip2.prepend(getLine(val) + '<br>');
    $txt2.val('');
  });

  var $txt3 = $('#txt3');
  var $tip3 = $('#tip3');
  $('#btn3').click(function() {
    var val = $txt3.val();
    $tip3.text(switchJinzhi(val, 8));
  });

  var $txt4 = $('#txt4');
  var $tip4 = $('#tip4');
  $('#btn4').click(function() {
    var val = $txt4.val();
    $tip4.text(getExpressionValue(val));
    // $txt4.val('');
  });


  var symbols = ['+', '-', '*', '/', '(', ')', '#'];
  var preceds = genPreceds();

  function getExpressionValue(str) {
    var optr = ['#'];
    var opnd = [];
    var n = '';
    var item;
    str += '#';
    for (var i in str) {
      item = str[i];
      if (symbols.indexOf(item) > -1) {
        var pr = optr[optr.length - 1];
        var gp = getPreceds(pr, item);
        if (gp === -1) {
          optr.push(item);
          if (n) {
            opnd.push(n);
            n = '';
          }
        } else if (gp === 0) {
          optr.pop();
        } else {
          optr.pop();
          opnd.push(operate(opnd.pop(), n, pr));
          n = '';
        }
      } else if (item === ' ') {
        opnd.push(n);
        n = '';
      } else {
        n += item;
      }
    }
    if (item === '#' && optr.pop() === '#') {
      return opnd.pop();
    } else {
      throw new Error('出错了');
    }
  }

  function operate(a, b, op) {
    if (op === '+') {
      return +a + (+b);
    } else if (op === '-') {
      return a - b;
    } else if (op === '*') {
      return a * b;
    } else if (op === '/') {
      return a / b;
    }
  }

  function getPreceds(a, b) {
    var i = symbols.indexOf(a);
    var j = symbols.indexOf(b);
    if (i >= 0 && j >= 0) {
      var c = i * symbols.length + j;
      var v = preceds[c];
      if (v === undefined) {
        throw new Error('出错');
      }
      return v;
    } else {
      throw new Error('出错');
    }
  }

  function genPreceds() {
    var len = symbols.length;
    var preceds = Array(Math.pow(len, 2));
    for (var i = 0; i < len; i++) {
      var _i = symbols[i];
      for (var j = 0; j < len; j++) {
        var _j = symbols[j];
        var v = undefined;
        if (_i === '#') {
          if (_j === '#') {
            v = 0;
          } else if (_j !== ')') {
            v = -1;
          }
        } else if (_j === '#') {
          if (_i !== '(') {
            v = 1;
          }
        } else if (_i === '+' || _i === '-') {
          if (_j === '+' || _j === '-' || _j === ')') {
            v = 1;
          } else {
            v = -1;
          }
        } else if (_i === '*' || _i === '/') {
          if (_j === '(') {
            v = -1;
          } else {
            v = 1;
          }
        } else if (_i === '(') {
          if (_j === ')') {
            v = 0;
          } else {
            v = -1;
          }
        } else if (_i === ')') {
          if (_j !== '(') {
            v = 1;
          }
        }
        preceds[i * len + j] = v;
      }
    }
    return preceds;
  }

  function switchJinzhi(number, t) {
    var arr = [];
    while (number) {
      arr.push(number % t);
      number = parseInt(number / t);
    }
    return arr.reverse().join('');
  }

  function getLine(str) {
    var arr = [];
    for (var i = 0, len = str.length; i < len; i++) {
      var item = str[i];
      if (item === '#') {
        arr.pop();
      } else if (item === '@') {
        arr.length = 0;
      } else {
        arr.push(item);
      }
    }
    return arr.join('');
  }

  function isMatchBrackets(str) {
    var arr = [];
    var len = str.length;
    var b = true;
    for (var i = 0; i < len; i++) {
      var item = str[i];
      if (item === '(' || item === '[' || item === '{') {
        arr.push(item);
      } else if (item === ')') {
        if (arr.pop() !== '(') {
          b = false;
        }
      } else if (item === ']') {
        if (arr.pop() !== '[') {
          b = false;
        }
      } else if (item === '}') {
        if (arr.pop() !== '{') {
          b = false;
        }
      }
    }
    if (arr.length) {
      b = false;
    }
    return b;
  }
  </script>
</body>

</html>
